# 编译课程申优文档

19373590 郭书阳

​		这里按编译实验作业的顺序，简单写一下个人在完成实验的过程中所遇到的问题以及解决方案。

### 词法分析

​		词法分析部分问题一般不大，用课堂上讲的有限状态机就可以了，唯一一个需要注意的小技巧就是把测试文件中的程序读进字符串后再依据数组下标分析，要比使用文件指针分析更可靠，不容易出错，也方便之后的预读和回溯。

### 语法分析

​		到了语法分析开始和课程组给定的文法打交道，这个阶段看文法主要看文法的直观结构，保证在编写程序的时候能做到语法成分不重不漏，之后就是利用递归下降分析法针对每个语法成分编写分析程序。

​		在使用递归下降分析法时，要注意文法的结构特点。课程组给的文法有很大可能不是LL（1）的，对带有左递归的文法要进行改写，对规则右侧多个选择有FIRST集相交的要实现预读或者回溯。个人实现的是预读，在实现预读时，要仔细分析语法成分，保证考虑到所有可能性，之后确定不同语法成分相交的范围，以此编写准确高效的预读。

### 错误处理——符号表

​		第三次作业名为错误处理，实则是符号表的应用，作业的核心还是符号表。在设计符号表时，首先要根据语言的特点，确定符号表怎么设计，保证符号表可以存储所有在之后的分析过程中需要用到的信息。

​		符号表主要由三个部分组成，一是符号，二是存储符号的数据结构，三是对符号和数据结构的操作函数。符号方面主要就是考虑如何完整地描述一个符号，确定符号的属性。数据结构方面主要就是根据语言的结构，确定符号表的组织形式，如要不要区分全局和局部，支持嵌套或非嵌套。操作函数方面就是根据编译器其他部分对符号表的要求，编写增删改查一类的函数。

​		这次作业中我遇到的问题主要是在数据结构部分，由于文法允许block嵌套，因此局部符号表也应该是嵌套的，并且还要设一个栈储存当前block的局部符号表和所有包含这个block的block的局部符号表。但我在第一次写的时候没有区分函数block和语句block，由于函数参数是在函数block之前被读入，所以函数block在新建空符号表之后，还应该把函数参数读入新建的符号表。

### 中间代码生成

​		中间代码生成部分，顾名思义，核心就是中间代码。由于我选择的是生成mips，我只讲一下生成mips的中间代码生成的思路，中间代码默认为四元式。

​		中间代码生成，最重要的就是中间代码的设计，中间代码的设计决定了你编写中间代码生成程序的难度，设计越合理，写起来就越轻松。由于中间代码是为生成目标代码服务的，所以在设计中间代码时，我们可以从mips指令中倒推出一些比较简单的中间代码。同时，因为mips的部分指令也是类似于四元式的形式，这更方便了我们的设计。如Add,Minus,Mul,Div等运算指令，可以直接当作四元式拿来用，翻译成mips非常方便。J这种跳转指令，也可以直接用，只需要一个地址作为操作数。除此之外的中间代码，就要考虑语义了，这里需要将给定语言可能进行的操作分类，简单的如输入输出，函数/变量声明等，复杂的如数组取值赋值等。总之中间代码所能表示的语义要覆盖文法中语句的语义。根据这些操作确定操作符之后，配合操作符的操作数也就基本确定了，操作符和操作数一起表达了完整的语义。

​		这次作业中遇到的问题一是数组取地址的问题，数组取地址与数组取值不同，需要单独一类的操作符，除此之外，储存数组取地址结果的符号也应该有一个属性，标识这个符号为储存地址的指针，以便后续函数传参时实参给形参赋值。二是条件跳转的相关中间代码，为实现短路求值，第一次我尝试使用And和Or这种表达式求值形式的操作符，最终没能实现。第二次我**借鉴了gcc编译器对短路求值的处理方法**，直接使用mips条件跳转指令作为操作符，并将当前And条件表达式的值存放在某个确定的寄存器中，在判断Or条件表达式时再取出进行比较，之后跳转。

### 目标代码生成

​		目标代码生成需要对mips指令集与mips汇编程序的运行有一定程度的理解，如果计组学的mips忘记了还是建议回去看一看，非常有用。

​		目标代码生成，首先要解决寄存器和内存的分配问题，寄存器分配可以按照mips的标准分配来，也可以按自己的设计来，不冲突就可以。至于程序运行时的内存分配，可以参考一些范例mips程序，看看这些程序在储存变量或者调用函数时是怎么处理的，之后将这种内存分配应用到自己的目标代码生成中。

​		解决这个问题之后，就正式进入中间代码翻译为目标代码的过程。前一部分中间代码生成中，有部分从mips指令里倒推出来的中间代码，这种再生成目标代码很简单，操作符对指令，操作数对内存位置或寄存器，直接翻译就行。其他从语义来的中间代码，需要自己考虑实现这类中间代码需要几个步骤。以数组赋值为例：一是需要数组符号的位置，也就是数组起始位置；二是需要数组下标，也就是数组中的偏移量；三是需要等号右侧的值，也就是所赋的值。此外，在翻译这类中间代码时，**要考虑每个操作数的位置**，在内存还是在寄存器，用mips指令依次实现这几个步骤，从而达到翻译中间代码为mips指令的目的。

​		比较值得注意的还是函数调用相关的mips指令生成。不至于说十分复杂，但确实需要一些耐心，搞清楚函数调用的整个过程，每个步骤都需要做什么，步骤的顺序是怎么样的，为什么要按这个顺序。然后再写函数调用的翻译，效果会好很多。
